---
title: "Estimation after blinded interim analysis"
subtitle: "Supplementary Simulations"
author: Florian Klinglmueller
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  \usepackage[utf8]{inputenc}
---

```{r knitr options,echo=F}
knitr::opts_chunk$set(echo=FALSE,warning=FALSE,results='hide',fig.width=7,fig.height=7,message=FALSE)
```
```{r libraries}
## For running the simulations and plotting the results the following
## packages have to be loaded:
library(parallel)
## devtools::install_github('floatofmath/blindConfidence')
library(blindConfidence)
library(ggplot2)
library(reshape2)
library(plyr)
library(mgcv)
options(mc.cores=min(10,detectCores()-1))
```

```{r load data maximum bias,eval=T,echo=F}
data(maxsim)

full.sim <- maxsim
maxsim$ylow <- 0
```

Looking at the results we conjecture that the maximum of the variance
bias is attained for $\delta=0$ and $\sigma = \Infty$. We perform a
simualtion study for $n_1 \in \{2,...,50\}$ setting $\delta=0$ and
$\sigma=10$. 


```{r simulate_uvb}
options(mc.cores=20)
scenarios_uvb <- expand.grid(n1=2:50,delta=0,sigma=10,d=1)
results_uvb <- simulate_batch(scenarios_uvb,4*10^6,use=TRUE)
data(maxvariancesim)
save(results_uvb,file='~/newBlindedResults/max_uvb.rda')


## load("~/srv-home/newBlindedResults/max_uvb.rda")
## ggplot(results_uvb,aes(n1,variance.bias))+geom_path()+geom_path(data=subset(maxvariancesim3,what.max=='uc.variance.bias'),linetype=2)

```

The resulting bias estimates lie consistently below (albeit only
slightly) the maxima found in the unrestricted simulation probably the
assumption that the maximum is reached for $\sigma \rightarrow \Infty$
is not true.

```{r simulate_vb}
scenarios_vbur <- add_epsilon(scenarios_vb,0.2,0.05,'sigma')
scenarios_uvbur <- add_epsilon(scenarios_uvb,0.2,0.05,'sigma')

candidates_vbur <- simulate_batch(scenarios_vbur,10^7,use=T)
candidates_uvbur <- simulate_batch(scenarios_uvbur,10^7,use=T)
final_scenarios_vbur <- select_results(candidates_vbur,c("variance.bias"),base_columns=c('n1','delta',"sigma","d"))
final_scenarios_uvbur <- select_results(candidates_uvbur,c("uc.variance.bias"),base_columns=c('n1','delta',"sigma","d"))
final_results_vbur <- simulate_batch(final_scenarios_vbur,10^7,use=T)
final_results_uvbur <- simulate_batch(final_scenarios_uvbur,10^7,use=T)
save(candidates_vbur,final_results_vbur,final_scenarios_uvbur,final_results_uvbur,file="~/newBlindedResults/max_uvbur.rda")
load("~/srv-home/newBlindedResults/max_uvbur.rda")


par(mfrow=c(2,1))
plot_scenarios(maxsim,final_scenarios_vbur,scenarios_vbur,'sigma','n1')
plot_scenarios(maxsim,final_scenarios_uvbur,scenarios_uvbur,'sigma','n1')
ggplot(results_uvbur,aes(n1,uc.variance.bias))+geom_path()+geom_path(data=subset(maxvariancesim3,what.max=='uc.variance.bias'),linetype=2)
ggplot(results_vbur,aes(n1,variance.bias))+geom_path()+geom_path(data=subset(maxvariancesim3,what.max=='variance.bias'),linetype=2)

vb_old <- subset(maxvariancesim3,what.max=='variance.bias')[,list(n1,variance.bias)]
vb_new <- results_vbur[,list(n1,variance.bias)]

setkey(vb_new,n1)
setkey(vb_old,n1)
vb_both <- vb_old[vb_new,]
vb_both[,diff:=i.variance.bias - variance.bias]
vb_both[,mean(diff)]
vb_both[,t.test(diff)]
ggplot(vb_both,aes(n1,diff))+geom_line()+geom_abline(intercept=0,slope=0)
vb_both[,mean(diff)]
colMeans(as.matrix(vb_old-vb_new))

```

```{r model_based_simulation}
candidates_uvbur[,reps:=10^7]
candidates_vbur[,reps:=10^7]
maxsim[,reps:=10^6]
collected_results <- rbind(candidates_uvbur,candidates_vbur,maxsim,fill=T)

collected_results[,w_reps := reps/mean(reps)]
model_uvb0 <- gam(uc.variance.bias~s(n1)+s(sigma) + te(n1,sigma),data=subset(collected_results,delta==0),weights=w_reps)
summary(model_uvb0)

scenarios_uvb0 <- expand.grid(n1=2:50,sigma=seq(0,4,0.01),delta=0,d=1)
candidates_uvb0 <- predict(model_uvb0,newdata=scenarios_uvb0,se=T)
scenarios_uvb0$fit <- candidates_uvb0$fit
scenarios_uvb0$se <- candidates_uvb0$se
results_uvb0 <- select_results(data.table(scenarios_uvb0),'fit',base=c('delta','d','n1','sigma','se'))


grow_grid <- function(grid,parameter,by=.1,len_out=nrow(grid)*10,se=T){
    N <- nrow(grid)
    m <- ceiling(len_out/N)
    if(se) by <- by*with(grid,scale(se,min(se),diff(range(se))))
    par_idx <- which(colnames(grid)==parameter)
    out <- do.call('rbind',lapply(1:N,function(i) cbind(grid[rep(i,m),-par_idx,with=F],seq(grid[i,][[par_idx]]-by[i,],grid[i,][[par_idx]]+by[i,],length.out=m))))
    colnames(out) <- c(colnames(grid)[-par_idx],parameter)
    out
}
                          
candidates_uvb0 <- grow_grid(results_uvb0,'sigma')
intermediate_results_uvb0 <- simulate_batch(as.data.frame(candidates_uvb0),10^7,use=T)
final_scenarios_uvb0 <- select_results(intermediate_results_uvb0,'uc.variance.bias',base=c('delta','d','n1','sigma','se'))
final_results_uvb0 <- simulate_batch(as.data.frame(final_scenarios_uvb0),10^7,use=T)

save(model_uvb0,scenarios_uvb0,intermediate_results_uvb0,final_results_uvb0,file="~/newBlindedResults/max_uvb0.rda")
load("~/srv-home/newBlindedResults/max_uvb0.rda")

ggplot(final_results_uvb0,aes(n1,uc.variance.bias))+geom_path()+geom_path(data=subset(maxvariancesim3,what.max=='uc.variance.bias'),linetype=2)



```

```{r resim_variance,eval=F}

model_vb <- gam(variance.bias~s(n1)+s(delta)+s(sigma)+te(n1,sigma)+te(n1,delta)+te(delta,sigma),data=maxsim)
model_uvb <- gam(uc.variance.bias~s(n1)+s(delta)+s(sigma)+te(n1,sigma)+te(n1,delta)+te(delta,sigma),data=maxsim)

summary(model_vb)
summary(model_uvb)

grid <- expand.grid(n1=10,sigma=seq(0,4,.1),delta=seq(0,4,.1))
predict_vb <- predict(model_vb,grid)
persp(seq(0,4,.1),seq(0,4,.1),matrix(-predict_vb,ncol=41,nrow=41),xlab=expression(sigma),ylab=expression(delta),zlab='Max. abs. Variance Bias',theta=-45)

predict_uvb <- predict(model_uvb,grid)
persp(seq(0,4,.1),seq(0,4,.1),matrix(-predict_uvb,ncol=41,nrow=41),xlab=expression(sigma),ylab=expression(delta),zlab='Max. abs. Variance Bias',theta=220,phi=20)


grid_d0 <- expand.grid(n1=0:40,sigma=seq(0,4,.1),delta=0)
predict_vb_d0s4 <- predict(model_vb,grid_d0)
persp(0:40,seq(0,4,.1),matrix(-predict_vb_d0s4,ncol=41,nrow=41),xlab=expression(n[1]),ylab=expression(sigma),zlab='Max. abs. Variance Bias',theta=70,phi=10)


plot(model_uvb,page=1,pers=T)

predict_uvb_d0s4 <- predict(model_uvb,grid_d0)
persp(0:40,seq(0,4,.1),matrix(-predict_uvb_d0s4,ncol=41,nrow=41),xlab=expression(n[1]),ylab=expression(sigma),zlab='Max. abs. Variance Bias',theta=70,phi=20)


grid <- expand.grid(n1=2:50,sigma=seq(0,4,.1),delta=seq(0,4,.1))
predict_vb <- predict(model_vb,newdata=grid)
predict_uvb <- predict(model_uvb,newdata=grid)
choices <- data.table(cbind(grid,variance.bias = predict_vb,uc.variance.bias = predict_uvb))

maxvarianceopt_direct <- blindConfidence::select_results(maxsim,c('variance.bias','uc.variance.bias'),base_columns=c('n1','delta','sigma'))
maxvarianceopt_smooth <- blindConfidence::select_results(choices,c('variance.bias','uc.variance.bias'),base_columns=c('n1','delta','sigma'))


G2variance_smooth <- add_epsilon(maxvarianceopt_smooth,.05,.01,c('delta','sigma'))
G2variance_direct <- add_epsilon(maxvarianceopt_direct,.05,.01,c('delta','sigma'))
par(mfrow=c(2,1))
plot_scenarios(maxsim,maxvarianceopt_smooth,G2variance_smooth,'sigma','n1')
plot_scenarios(maxsim,maxvarianceopt_direct,G2variance_direct,'sigma','n1')
par(mfrow=c(2,1))
plot_scenarios(maxsim,maxvarianceopt_smooth,G2variance_smooth,'delta','n1')
plot_scenarios(maxsim,maxvarianceopt_direct,G2variance_direct,'delta','n1')


options(mc.cores=min(20,detectCores()-1))
maxvariancesim2 <- simulate_batch(G2variance,4*10^6)
## reshape and resim
maxvarianceopt2 <- select_results(maxvariancesim2,c('variance.bias','uc.variance.bias'),base_columns=c('n1','tn1','delta','sigma','d','s'))
plot_grid(G2variance,maxvarianceopt1,maxvarianceopt2,'delta')
maxvariancesim3 <- simulate_batch(maxvarianceopt2,10^7)
fname <- paste('resim_variance',Sys.info()['nodename'],'_',format(Sys.time(),"%y%m%d"),'.Rd',sep='')
save(maxvariancesim3,file=fname)

```

